<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetCare - Clínica Veterinária</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo customizado para fontes e elementos */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Esconder todas as seções por padrão e mostrar via JS */
        .page-section { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <header class="bg-indigo-700 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-white tracking-wider">PetCare</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-home" class="text-white hover:bg-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Home</button>
                    <button id="nav-area-cliente" class="text-white bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-md text-sm font-medium transition duration-150 shadow-lg">Área do Cliente</button>
                    <button id="nav-logout" class="hidden text-red-300 hover:text-red-100 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Sair</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 w-full">

        <div id="notification-area" class="fixed top-20 right-5 z-50"></div>
        
        <section id="loading-section" class="page-section p-8 flex items-center justify-center min-h-[300px]">
             <div class="flex flex-col items-center">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-indigo-700">Carregando dados...</p>
            </div>
        </section>

        <section id="home-section" class="page-section p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-6 border-b-2 pb-2">Bem-vindo(a) à PetCare</h1>
            <p class="text-lg text-gray-600 mb-8">Cuidamos dos seus pets pequenos e domésticos com a excelência que eles merecem. Veja nossas especialidades e valores.</p>

            <h2 class="text-3xl font-semibold text-indigo-600 mb-4">Nossas Especialidades e Valores (Estimados)</h2>
            <div id="especialidades-list" class="space-y-4">
                <div class="text-gray-500 text-center p-4">Carregando especialidades...</div>
            </div>
        </section>

        <section id="auth-section" class="page-section max-w-md mx-auto p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6" id="auth-title">Entrar na Área do Cliente</h1>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-senha" class="block text-sm font-medium text-gray-700">Senha:</label>
                    <input type="password" id="login-senha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" id="login-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">Entrar</button>
            </form>

            <p class="mt-6 text-center text-sm text-gray-600">
                Novo por aqui?
                <button id="toggle-cadastro-btn" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Cadastre-se Agora
                </button>
            </p>

            <form id="cadastro-form" class="space-y-4 mt-8 hidden">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4 border-t pt-4">Novo Cadastro</h2>
                <div>
                    <label for="cadastro-nome" class="block text-sm font-medium text-gray-700">Nome Completo:</label>
                    <input type="text" id="cadastro-nome" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cadastro-cpf" class="block text-sm font-medium text-gray-700">CPF (apenas números):</label>
                    <input type="text" id="cadastro-cpf" required maxlength="11" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cadastro-email" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="cadastro-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cadastro-telefone" class="block text-sm font-medium text-gray-700">Telefone (DDD + Número):</label>
                    <input type="tel" id="cadastro-telefone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cadastro-senha" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres):</label>
                    <input type="password" id="cadastro-senha" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" id="cadastro-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">Confirmar Cadastro</button>
            </form>
        </section>

        <section id="dashboard-section" class="page-section p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-6">Olá, <span id="tutor-nome-display">Cliente!</span></h1>
            
            <div id="complete-profile-container" class="mb-8 p-6 bg-red-50 border border-red-300 rounded-lg shadow-md hidden">
                <h2 class="text-2xl font-bold text-red-700 mb-3">⚠️ Cadastro Incompleto</h2>
                <p class="text-red-600 mb-4">Seus dados pessoais não foram finalizados. Por favor, complete as informações abaixo para acessar todos os recursos da clínica.</p>
                <form id="complete-profile-form" class="space-y-4">
                    <div>
                        <label for="complete-nome" class="block text-sm font-medium text-gray-700">Nome Completo:</label>
                        <input type="text" id="complete-nome" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="complete-cpf" class="block text-sm font-medium text-gray-700">CPF (apenas números):</label>
                        <input type="text" id="complete-cpf" required maxlength="11" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="complete-telefone" class="block text-sm font-medium text-gray-700">Telefone (DDD + Número):</label>
                        <input type="tel" id="complete-telefone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button type="submit" id="complete-profile-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                        Finalizar Cadastro
                    </button>
                </form>
            </div>
            
            <div id="dashboard-content">
                <p class="text-lg text-gray-600 mb-8">Gerencie seus pets e consultas.</p>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-indigo-100 p-4 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                        <h2 class="text-xl font-semibold text-indigo-800 mb-2">Cadastrar Novo Pet</h2>
                        <p class="text-indigo-600 text-sm mb-4">Adicione um novo companheiro à sua conta.</p>
                        <button id="show-cadastro-pet" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Novo Pet</button>
                    </div>

                    <div class="bg-green-100 p-4 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                        <h2 class="text-xl font-semibold text-green-800 mb-2">Agendar Consulta</h2>
                        <p class="text-green-600 text-sm mb-4">Escolha a especialidade, data e horário.</p>
                        <button id="show-agendar-consulta" class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Agendar</button>
                    </div>

                    <div class="bg-gray-100 p-4 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Histórico de Consultas</h2>
                        <p class="text-gray-600 text-sm mb-4">Visualize e gerencie suas consultas.</p>
                        <button id="show-historico" class="w-full py-2 px-4 bg-gray-600 text-white rounded-md hover:bg-gray-700">Histórico</button>
                    </div>
                    
                    <div class="bg-red-100 p-4 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                        <h2 class="text-xl font-semibold text-red-800 mb-2">Encerrar Sessão</h2>
                        <p class="text-red-600 text-sm mb-4">Saia com segurança da sua conta.</p>
                        <button id="dashboard-logout-btn" class="w-full py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700">Sair Agora</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="cadastro-pet-section" class="page-section max-w-md mx-auto p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-3xl font-bold text-indigo-700 mb-6">Cadastro de Pet</h1>
            <form id="cadastro-pet-form" class="space-y-4">
                <div>
                    <label for="pet-nome" class="block text-sm font-medium text-gray-700">Nome do Pet:</label>
                    <input type="text" id="pet-nome" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="pet-especie" class="block text-sm font-medium text-gray-700">Espécie:</label>
                    <select id="pet-especie" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">Selecione a Espécie</option>
                        <option value="Cachorro">Cachorro</option>
                        <option value="Gato">Gato</option>
                        <option value="Pássaro">Pássaro</option>
                        <option value="Roedor">Roedor (Hamster, Porquinho-da-Índia, etc.)</option>
                    </select>
                </div>
                <div>
                    <label for="pet-raca" class="block text-sm font-medium text-gray-700">Raça:</label>
                    <select id="pet-raca" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">Selecione a Espécie Primeiro</option>
                    </select>
                </div>
                <div>
                    <label for="pet-nascimento" class="block text-sm font-medium text-gray-700">Data de Nascimento:</label>
                    <input type="date" id="pet-nascimento" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">Salvar Pet</button>
            </form>
            <button id="back-to-dashboard-pet" class="mt-4 text-sm text-gray-500 hover:text-indigo-600">Voltar para o Dashboard</button>
        </section>

        <section id="agendar-consulta-section" class="page-section p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-3xl font-bold text-indigo-700 mb-6">Agendamento de Consulta</h1>

            <div id="pets-list-to-agenda" class="mb-6 space-y-3">
                <h2 class="text-xl font-semibold text-gray-700">Seus Pets Cadastrados:</h2>
                <div id="pets-options-container" class="space-y-2">
                    <p class="text-gray-500">Carregando seus pets...</p>
                </div>
            </div>

            <div id="agendamento-form-container" class="hidden border-t pt-6 mt-6">
                <h2 class="text-xl font-semibold text-green-700 mb-4">Detalhes do Agendamento</h2>

                <form id="agendamento-consulta-form" class="space-y-4">
                    <input type="hidden" id="selected-pet-id">

                    <div>
                        <label for="agendar-especialidade" class="block text-sm font-medium text-gray-700">Especialidade:</label>
                        <select id="agendar-especialidade" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="">Selecione a Especialidade</option>
                        </select>
                    </div>

                    <div>
                        <label for="agendar-data" class="block text-sm font-medium text-gray-700">Data (Segunda a Sábado):</label>
                        <input type="date" id="agendar-data" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>

                    <div>
                        <label for="agendar-hora" class="block text-sm font-medium text-gray-700">Horário Disponível (06:00h às 20:00h, Intervalo de 1h):</label>
                        <select id="agendar-hora" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="">Selecione a Data Primeiro</option>
                        </select>
                    </div>

                    <div id="valor-consulta-display" class="text-lg font-bold text-indigo-700 bg-indigo-100 p-3 rounded-md shadow-inner">
                        Valor da Consulta: R$ 0.00
                    </div>

                    <button type="submit" id="finalizar-agendamento-btn" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150">
                        Finalizar Agendamento
                    </button>
                </form>
            </div>
            <button id="back-to-dashboard-agenda" class="mt-6 text-sm text-gray-500 hover:text-indigo-600">Voltar para o Dashboard</button>
        </section>

        <section id="historico-section" class="page-section p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-3xl font-bold text-indigo-700 mb-6">Histórico de Consultas</h1>

            <div id="historico-list" class="space-y-4">
                </div>

            <div id="relatorio-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">Relatório Médico</h2>
                    <div id="relatorio-content" class="whitespace-pre-wrap text-gray-700 border p-3 bg-gray-50 rounded-md min-h-20">
                        </div>
                    <button id="close-relatorio-modal" class="mt-4 py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700">Fechar</button>
                </div>
            </div>

            <button id="back-to-dashboard-historico" class="mt-6 text-sm text-gray-500 hover:text-indigo-600">Voltar para o Dashboard</button>
        </section>

        <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h2 class="text-xl font-bold text-indigo-700 mb-4">Confirmação</h2>
                <p id="confirm-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-agendamento-btn" class="py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600">Cancelar</button>
                    <button id="confirm-agendamento-btn" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // =========================================================================
        // ⚠️ IMPORTANTE: MANTENHA SUAS CHAVES ORIGINAIS AQUI
        const SUPABASE_URL = 'https://jweuedxsfrxjkzkdbkas.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZXVlZHhzZnJ4amt6a2Ria2FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTA4MDcsImV4cCI6MjA3OTA2NjgwN30.0FnNI4RXLgwE0fkL1HJ9Qgi9hglLtKmdfbuxARrraFs';
        // =========================================================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let tutorData = null; 
        let allEspecialidades = [];
        let allMedicos = [];
        let appIsReady = false;

        // --- UTILS ---

        function getCurrentDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function setMinDate() {
            const dateInput = document.getElementById('agendar-data');
            if (dateInput) {
                dateInput.min = getCurrentDateString();
            }
        }
        
        function setButtonLoading(buttonId, isLoading, defaultText) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            button.disabled = isLoading;
            button.textContent = isLoading ? 'Aguarde...' : defaultText;
            button.classList.toggle('opacity-50', isLoading);
            button.classList.toggle('cursor-not-allowed', isLoading);
        }

        function showNotification(message, type) {
            const container = document.getElementById('notification-area');
            const colorClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const html = `
                <div class="${colorClass} text-white px-4 py-2 rounded-lg shadow-xl mb-3 transition duration-500 transform translate-x-0 opacity-100" role="alert">
                    ${message}
                </div>
            `;
            const notification = document.createElement('div');
            notification.innerHTML = html;
            container.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function updateNavButtons(isLoggedIn) {
            document.getElementById('nav-logout').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('nav-area-cliente').classList.toggle('hidden', isLoggedIn);
        }

        function navigateTo(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            const user = supabase.auth.currentUser;
            const isLoggedIn = !!user;
            updateNavButtons(isLoggedIn);
            if (sectionId === 'dashboard-section') {
                updateDashboardDisplay();
            }
        }

        function showConfirmationModal(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-message').textContent = message;
                modal.classList.remove('hidden');

                const confirmBtn = document.getElementById('confirm-agendamento-btn');
                const cancelBtn = document.getElementById('cancel-agendamento-btn');

                const handler = (result) => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    resolve(result);
                };

                const confirmHandler = () => handler(true);
                const cancelHandler = () => handler(false);

                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            });
        }

        // --- AUTH LOGIC ---
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (!appIsReady) {
                navigateTo('loading-section');
            }
            if (session) {
                await loadTutorData(session.user.id);
                document.getElementById('tutor-nome-display').textContent = tutorData ? tutorData.nome.split(' ')[0] : 'Cliente';
                updateNavButtons(true);
                navigateTo('dashboard-section');
            } else {
                tutorData = null;
                updateNavButtons(false);
                navigateTo('home-section');
            }
            appIsReady = true;
        });

        async function loadTutorData(userId) {
            const { data, error } = await supabase
                .from('tutores')
                .select('nome, id, cpf, telefone')
                .eq('id', userId)
                .single();
            if (error) {
                if (error.code === 'PGRST116') {
                    tutorData = null;
                    return;
                }
                console.error("Erro ao carregar dados do tutor:", error);
                showNotification(`Erro ao carregar seus dados: ${error.message}.`, 'error');
                tutorData = null;
                return;
            }
            tutorData = data;
        }
        
        function updateDashboardDisplay() {
            const isProfileComplete = !!tutorData;
            if (!isProfileComplete) {
                const user = supabase.auth.currentUser;
                if (user && user.email) {
                    document.getElementById('complete-nome').value = '';
                    document.getElementById('complete-cpf').value = '';
                    document.getElementById('complete-telefone').value = '';
                }
            }
            document.getElementById('complete-profile-container').classList.toggle('hidden', isProfileComplete);
            document.getElementById('dashboard-content').classList.toggle('hidden', !isProfileComplete);
            document.getElementById('tutor-nome-display').textContent = tutorData ? tutorData.nome.split(' ')[0] : 'Cliente';
        }

        async function sessionHeartbeat() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                if (!tutorData) {
                    await loadTutorData(session.user.id);
                    if (document.getElementById('dashboard-section').style.display === 'block') {
                         updateDashboardDisplay();
                    }
                }
            } else {
                if (tutorData) {
                    tutorData = null;
                    navigateTo('home-section');
                    showNotification('Sessão expirada. Por favor, faça login novamente.', 'error');
                }
            }
        }

        const HEARTBEAT_INTERVAL = 60000; 
        let heartbeatTimer = null; 

        function startHeartbeat() {
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            heartbeatTimer = setInterval(sessionHeartbeat, HEARTBEAT_INTERVAL);
        }

        async function loadEspecialidades() {
            const { data, error } = await supabase
                .from('especialidades')
                .select('*')
                .order('nome', { ascending: true });

            const listContainer = document.getElementById('especialidades-list');
            listContainer.innerHTML = '';

            if (error) {
                listContainer.innerHTML = `<p class="text-red-500">Erro ao carregar especialidades: ${error.message}</p>`;
                return [];
            }
            
            allEspecialidades = data; 
            
            data.forEach(esp => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-indigo-50 rounded-lg shadow-sm';
                item.innerHTML = `
                    <span class="font-medium text-lg text-indigo-800">${esp.nome}</span>
                    <span class="font-bold text-xl text-green-700">R$ ${esp.valor.toFixed(2).replace('.', ',')}</span>
                `;
                listContainer.appendChild(item);
            });
            return data;
        }

        // --- EVENT LISTENERS ---

        document.getElementById('nav-home').addEventListener('click', () => navigateTo('home-section'));
        
        document.getElementById('nav-area-cliente').addEventListener('click', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                if (!tutorData) await loadTutorData(session.user.id);
                navigateTo('dashboard-section'); 
            } else {
                navigateTo('auth-section');
            }
        });
        
        document.getElementById('nav-logout').addEventListener('click', async () => {
            await supabase.auth.signOut();
            showNotification('Você saiu da sua conta.', 'success');
        });
        
        document.getElementById('dashboard-logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            showNotification('Você saiu da sua conta.', 'success');
        });

        document.getElementById('toggle-cadastro-btn').addEventListener('click', () => {
            const isLogin = document.getElementById('cadastro-form').classList.contains('hidden');
            document.getElementById('cadastro-form').classList.toggle('hidden', !isLogin);
            document.getElementById('login-form').classList.toggle('hidden', isLogin);
            document.getElementById('auth-title').textContent = isLogin ? 'Crie Sua Conta' : 'Entrar na Área do Cliente';
            document.getElementById('toggle-cadastro-btn').textContent = isLogin ? 'Voltar para Login' : 'Cadastre-se Agora';
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loginBtn = 'login-submit-btn';
            setButtonLoading(loginBtn, true, 'Entrar');

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-senha').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            
            setButtonLoading(loginBtn, false, 'Entrar');

            if (error) {
                showNotification(`Erro ao logar: ${error.message}`, 'error');
                return;
            }
            showNotification('Login realizado com sucesso!', 'success');
            e.target.reset();
        });

        document.getElementById('cadastro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cadastroBtn = 'cadastro-submit-btn';
            const defaultText = 'Confirmar Cadastro';
            setButtonLoading(cadastroBtn, true, defaultText);

            const email = document.getElementById('cadastro-email').value;
            const password = document.getElementById('cadastro-senha').value;
            const nome = document.getElementById('cadastro-nome').value;
            const cpf = document.getElementById('cadastro-cpf').value.replace(/\D/g, '');
            const telefone = document.getElementById('cadastro-telefone').value;

            if (password.length < 6) {
                setButtonLoading(cadastroBtn, false, defaultText);
                showNotification('A senha deve ter no mínimo 6 caracteres.', 'error');
                return;
            }
            if (cpf.length !== 11) {
                setButtonLoading(cadastroBtn, false, defaultText);
                showNotification('O CPF deve conter exatamente 11 dígitos.', 'error');
                return;
            }
            if (!nome || !email || !telefone) {
                 setButtonLoading(cadastroBtn, false, defaultText);
                showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }

            const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
            
            if (authError) {
                showNotification(`Erro no cadastro: ${authError.message}`, 'error');
                setButtonLoading(cadastroBtn, false, defaultText);
                return;
            }

            if (!authData || !authData.user) {
                showNotification('Erro interno: Usuário não criado. Tente novamente.', 'error');
                setButtonLoading(cadastroBtn, false, defaultText);
                return;
            }

            const userId = authData.user.id;
            const { error: dbError } = await supabase
                .from('tutores')
                .insert([{ id: userId, nome, cpf, telefone }]);
            
            if (dbError) {
                let errorMessage = `Erro Crítico: Não foi possível finalizar o cadastro.`;
                if (dbError.code === '23505') {
                    if (dbError.details && dbError.details.includes('cpf_key')) {
                        errorMessage = 'Erro no Cadastro: O CPF fornecido já está registrado.';
                    } else if (dbError.details && dbError.details.includes('telefone_key')) {
                        errorMessage = 'Erro no Cadastro: O Telefone fornecido já está registrado.';
                    }
                }
                await supabase.auth.signOut();
                showNotification(errorMessage, 'error');
                e.target.reset(); 
                setButtonLoading(cadastroBtn, false, defaultText);
                return;
            }

            tutorData = { id: userId, nome, cpf, telefone }; 
            appIsReady = true;
            showNotification('Cadastro realizado com sucesso! Você está logado.', 'success');
            e.target.reset();
            setButtonLoading(cadastroBtn, false, defaultText);
            document.getElementById('tutor-nome-display').textContent = tutorData.nome.split(' ')[0];
            navigateTo('dashboard-section');
        });
        
        document.getElementById('complete-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const completeBtn = 'complete-profile-submit-btn';
            const defaultText = 'Finalizar Cadastro';
            setButtonLoading(completeBtn, true, defaultText);
            
            const user = supabase.auth.currentUser;
            if (!user) {
                setButtonLoading(completeBtn, false, defaultText);
                showNotification("Sua sessão expirou.", 'error');
                navigateTo('auth-section');
                return;
            }

            const nome = document.getElementById('complete-nome').value;
            const cpf = document.getElementById('complete-cpf').value.replace(/\D/g, '');
            const telefone = document.getElementById('complete-telefone').value;
            const userId = user.id;

            if (cpf.length !== 11) {
                setButtonLoading(completeBtn, false, defaultText);
                showNotification('O CPF deve conter exatamente 11 dígitos.', 'error');
                return;
            }
            
            const { error: dbError } = await supabase
                .from('tutores')
                .insert([{ id: userId, nome, cpf, telefone }]);

            setButtonLoading(completeBtn, false, defaultText);

            if (dbError) {
                let errorMessage = `Erro ao finalizar cadastro.`;
                if (dbError.code === '23505') errorMessage = 'Erro: CPF ou Telefone já em uso.';
                showNotification(errorMessage, 'error');
                return;
            }

            tutorData = { id: userId, nome, cpf, telefone }; 
            showNotification('Dados atualizados com sucesso!', 'success');
            e.target.reset();
            updateDashboardDisplay();
        });

        // --- PETS LOGIC ---

        document.getElementById('show-cadastro-pet').addEventListener('click', () => {
            if (!tutorData) {
                showNotification("Complete seu cadastro primeiro.", 'error');
                updateDashboardDisplay();
                return;
            }
            navigateTo('cadastro-pet-section');
        });
        document.getElementById('back-to-dashboard-pet').addEventListener('click', () => navigateTo('dashboard-section'));

        const racasPorEspecie = {
            'Cachorro': ['Vira-Lata', 'Poodle', 'Labrador', 'Shih Tzu', 'Bulldog Francês', 'Outra'],
            'Gato': ['SRD', 'Siamês', 'Persa', 'Maine Coon', 'Ragdoll', 'Outra'],
            'Pássaro': ['Calopsita', 'Periquito', 'Canário', 'Agapornis', 'Outra'],
            'Roedor': ['Hamster Sírio', 'Porquinho-da-Índia', 'Gerbil', 'Outra']
        };

        document.getElementById('pet-especie').addEventListener('change', (e) => {
            const especie = e.target.value;
            const racaSelect = document.getElementById('pet-raca');
            racaSelect.innerHTML = '<option value="">Selecione a Raça</option>';
            if (racasPorEspecie[especie]) {
                racasPorEspecie[especie].forEach(raca => {
                    const option = document.createElement('option');
                    option.value = raca;
                    option.textContent = raca;
                    racaSelect.appendChild(option);
                });
            }
        });

        document.getElementById('cadastro-pet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!tutorData || !tutorData.id) {
                showNotification("Erro: Dados do tutor não carregados.", 'error');
                return;
            }
            const petData = {
                tutor_id: tutorData.id,
                nome: document.getElementById('pet-nome').value,
                especie: document.getElementById('pet-especie').value,
                raca: document.getElementById('pet-raca').value,
                data_nascimento: document.getElementById('pet-nascimento').value
            };
            const { error } = await supabase.from('pets').insert([petData]);
            if (error) {
                showNotification(`Erro ao cadastrar pet: ${error.message}`, 'error');
                return;
            }
            showNotification(`${petData.nome} cadastrado com sucesso!`, 'success');
            document.getElementById('cadastro-pet-form').reset();
            navigateTo('dashboard-section');
        });

        // --- AGENDA LOGIC ---

        document.getElementById('show-agendar-consulta').addEventListener('click', async () => {
             if (!tutorData) {
                showNotification("Complete seu cadastro primeiro.", 'error');
                updateDashboardDisplay();
                return;
            }
            navigateTo('agendar-consulta-section');
            loadEspecialidadesForAgenda();
            loadPetsForAgenda();
        });
        document.getElementById('back-to-dashboard-agenda').addEventListener('click', () => navigateTo('dashboard-section'));

        async function loadMedicos() {
            const { data, error } = await supabase.from('medicos').select('*');
            if (!error) allMedicos = data;
        }

        async function loadEspecialidadesForAgenda() {
            const select = document.getElementById('agendar-especialidade');
            select.innerHTML = '<option value="">Selecione a Especialidade</option>';
            if (!allEspecialidades.length) {
                const { data } = await supabase.from('especialidades').select('*');
                allEspecialidades = data || [];
            }
            allEspecialidades.forEach(esp => {
                const option = document.createElement('option');
                option.value = esp.id;
                option.textContent = esp.nome;
                option.dataset.valor = esp.valor;
                select.appendChild(option);
            });
        }

        async function loadPetsForAgenda() {
            const container = document.getElementById('pets-options-container');
            container.innerHTML = '';
            if (!tutorData || !tutorData.id) return;

            const { data: pets, error } = await supabase
                .from('pets')
                .select('*')
                .eq('tutor_id', tutorData.id);

            if (error || pets.length === 0) {
                container.innerHTML = error ? `<p class="text-red-500">${error.message}</p>` : `<p class="text-gray-500">Nenhum pet cadastrado.</p>`;
                document.getElementById('agendamento-form-container').classList.add('hidden');
                return;
            }

            pets.forEach(pet => {
                const petCard = document.createElement('div');
                petCard.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-md shadow-sm';
                petCard.innerHTML = `
                    <span class="font-medium text-gray-800">${pet.nome} (${pet.especie})</span>
                    <button data-pet-id="${pet.id}" data-pet-name="${pet.nome}" class="select-pet-btn py-1 px-3 bg-green-500 text-white rounded-md text-sm hover:bg-green-600">
                        Agendar Consulta
                    </button>
                `;
                container.appendChild(petCard);
            });

            document.querySelectorAll('.select-pet-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const petId = e.target.dataset.petId;
                    const petName = e.target.dataset.petName;
                    document.getElementById('selected-pet-id').value = petId;
                    showNotification(`Agendando para ${petName}.`, 'success');
                    document.getElementById('agendamento-form-container').classList.remove('hidden');
                });
            });
        }

        document.getElementById('agendar-data').addEventListener('change', () => updateAvailableHours());
        document.getElementById('agendar-especialidade').addEventListener('change', (e) => {
            updateAvailableHours();
            const selectedOption = e.target.options[e.target.selectedIndex];
            const valor = selectedOption.dataset.valor ? parseFloat(selectedOption.dataset.valor) : 0.00;
            document.getElementById('valor-consulta-display').textContent = `Valor da Consulta: R$ ${valor.toFixed(2).replace('.', ',')}`;
        });

        async function updateAvailableHours() {
            const dataInput = document.getElementById('agendar-data');
            const dataConsulta = dataInput.value;
            const horaSelect = document.getElementById('agendar-hora');
            const especialidadeId = document.getElementById('agendar-especialidade').value;

            horaSelect.innerHTML = '<option value="">Carregando Horários...</option>';

            if (!dataConsulta || !especialidadeId) {
                horaSelect.innerHTML = '<option value="">Selecione a Data e Especialidade</option>';
                return;
            }
            
            const todayString = getCurrentDateString();
            if (dataConsulta < todayString) {
                dataInput.value = '';
                horaSelect.innerHTML = '<option value="">Data inválida.</option>';
                showNotification('Selecione uma data futura.', 'error');
                return;
            }

            const dayOfWeek = new Date(dataConsulta + 'T00:00:00').getDay();
            if (dayOfWeek === 0) {
                dataInput.value = '';
                horaSelect.innerHTML = '<option value="">Fechado aos Domingos</option>';
                showNotification('Não agendamos aos Domingos.', 'error');
                return;
            }

            const { data: agendamentosExistentes } = await supabase
                .from('consultas')
                .select('hora_consulta')
                .eq('data_consulta', dataConsulta)
                .neq('status', 3);

            const horasOcupadas = new Set((agendamentosExistentes || []).map(a => a.hora_consulta));
            const horariosDisponiveis = [];
            const isToday = dataConsulta === todayString;
            const currentHour = isToday ? new Date().getHours() + 1 : -1; 

            for (let h = 6; h <= 19; h++) {
                const horaString = `${h.toString().padStart(2, '0')}:00:00`;
                if (isToday && h < currentHour) continue;
                if (!horasOcupadas.has(horaString)) horariosDisponiveis.push(horaString);
            }

            horaSelect.innerHTML = '<option value="">Selecione um Horário</option>';
            horariosDisponiveis.forEach(hora => {
                const option = document.createElement('option');
                option.value = hora;
                option.textContent = hora.substring(0, 5) + 'h';
                horaSelect.appendChild(option);
            });
            if (horariosDisponiveis.length === 0) horaSelect.innerHTML = '<option value="">Sem horários hoje</option>';
        }

        document.getElementById('agendamento-consulta-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const petId = document.getElementById('selected-pet-id').value;
            const especialidadeId = document.getElementById('agendar-especialidade').value;
            const dataConsulta = document.getElementById('agendar-data').value;
            const horaConsulta = document.getElementById('agendar-hora').value;

            if (!petId || !especialidadeId || !dataConsulta || !horaConsulta) {
                showNotification('Preencha todos os campos.', 'error');
                return;
            }
            
            const selectedDateTime = new Date(`${dataConsulta}T${horaConsulta}`);
            if (selectedDateTime <= new Date()) {
                showNotification('Selecione um horário futuro.', 'error');
                return;
            }

            const selectedEspecialidade = allEspecialidades.find(e => e.id == especialidadeId);
            const valorFormatado = selectedEspecialidade.valor.toFixed(2).replace('.', ',');
            
            const isConfirmed = await showConfirmationModal(`Valor: R$ ${valorFormatado}. Confirmar agendamento?`);
            if (!isConfirmed) return;

            const medicosEspecialidade = allMedicos.filter(m => m.especialidade_id == especialidadeId);
            if (medicosEspecialidade.length === 0) {
                showNotification('Nenhum médico disponível.', 'error');
                return;
            }
            const medicoId = medicosEspecialidade[Math.floor(Math.random() * medicosEspecialidade.length)].id;

            const agendamentoData = {
                pet_id: petId,
                medico_id: medicoId,
                especialidade_id: especialidadeId,
                data_consulta: dataConsulta,
                hora_consulta: horaConsulta,
                tutor_id: tutorData.id,
                status: 1 
            };

            const { error } = await supabase.from('consultas').insert([agendamentoData]);
            if (error) {
                showNotification(`Erro no agendamento: ${error.message}`, 'error');
                return;
            }

            showNotification('Consulta agendada!', 'success');
            document.getElementById('agendamento-consulta-form').reset();
            document.getElementById('agendamento-form-container').classList.add('hidden');
            navigateTo('dashboard-section');
        });

        // --- HISTÓRICO LOGIC (CORRIGIDO: VISIBILIDADE + REMOÇÃO SEGURA) ---

        document.getElementById('show-historico').addEventListener('click', async () => {
            if (!tutorData) {
                showNotification("Complete seu cadastro primeiro.", 'error');
                updateDashboardDisplay();
                return;
            }
            navigateTo('historico-section');
            await loadHistoricoConsultas();
        });
        document.getElementById('back-to-dashboard-historico').addEventListener('click', () => navigateTo('dashboard-section'));

        async function loadHistoricoConsultas() {
            const container = document.getElementById('historico-list');
            // Loading apenas na primeira carga ou se estiver vazio
            if(container.children.length === 0 || container.innerHTML.includes('Carregando')) {
                 container.innerHTML = '<div class="flex justify-center"><svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';
            }

            if (!tutorData || !tutorData.id) {
                container.innerHTML = `<p class="text-red-500">Erro: Dados do tutor não carregados.</p>`;
                return;
            }

            const { data: consultas, error } = await supabase
                .from('consultas')
                .select(`
                    id, data_consulta, hora_consulta, status,
                    pets (nome, especie),
                    medicos (nome),
                    especialidades (nome)
                `)
                .eq('tutor_id', tutorData.id)
                .order('data_consulta', { ascending: false })
                .order('hora_consulta', { ascending: false });

            if (error) {
                console.error("Erro ao carregar histórico:", error);
                container.innerHTML = `<p class="text-red-500">Erro ao carregar histórico: ${error.message}</p>`;
                return;
            }

            if (consultas.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4" id="no-consultas-msg">Você não possui consultas registradas.</p>`;
                return;
            }

            container.innerHTML = '';
            consultas.forEach(consulta => {
                const statusMap = { 1: 'Agendada', 2: 'Em Atendimento', 3: 'Finalizada' };
                let borderClass = 'border-indigo-500 bg-indigo-50';
                if (consulta.status === 3) borderClass = 'border-green-500 bg-white';
                
                let actionButtons = '';
                if (consulta.status === 3) {
                    actionButtons = `<button data-consulta-id="${consulta.id}" class="view-report-btn mt-3 py-1 px-3 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700 transition shadow-sm">Visualizar Relatório</button>`;
                } else if (consulta.status === 1) {
                    actionButtons = `<button data-cancel-id="${consulta.id}" class="cancel-appt-btn mt-3 py-1 px-3 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition shadow-sm flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> Cancelar Consulta</button>`;
                } else {
                    actionButtons = `<p class="mt-3 text-sm text-gray-500 italic">Em atendimento...</p>`;
                }

                const consultaCard = document.createElement('div');
                consultaCard.id = `card-consulta-${consulta.id}`;
                // CORREÇÃO: Removida a classe 'fade-out' que deixava tudo invisível
                consultaCard.className = `p-4 rounded-lg shadow-md border-l-4 ${borderClass} hover:shadow-lg transition duration-200`;
                consultaCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">${new Date(consulta.data_consulta).toLocaleDateString('pt-BR')} às ${consulta.hora_consulta.substring(0, 5)}h</p>
                            <h3 class="text-xl font-bold text-gray-800 mt-1">${consulta.pets.nome} <span class="text-sm font-normal text-gray-600">(${consulta.pets.especie})</span></h3>
                            <p class="text-gray-700 mt-1"><span class="font-medium">Especialidade:</span> ${consulta.especialidades.nome}</p>
                            <p class="text-gray-700"><span class="font-medium">Vet:</span> ${consulta.medicos.nome}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${consulta.status === 1 ? 'bg-blue-100 text-blue-800' : (consulta.status === 3 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800')}">
                            ${statusMap[consulta.status]}
                        </span>
                    </div>
                    <div class="mt-2 border-t pt-2 border-gray-200/50">
                        ${actionButtons}
                    </div>
                `;
                container.appendChild(consultaCard);
            });

            document.querySelectorAll('.view-report-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showRelatorioModal(e.target.dataset.consultaId));
            });
            
            document.querySelectorAll('.cancel-appt-btn').forEach(btn => {
                btn.addEventListener('click', (e) => cancelarConsulta(e.target.closest('button').dataset.cancelId));
            });
        }

        async function cancelarConsulta(consultaId) {
            const confirmou = await showConfirmationModal("Tem certeza que deseja cancelar esta consulta? O horário ficará vago novamente.");
            if (!confirmou) return;

            // Feedback visual no botão
            const btn = document.querySelector(`button[data-cancel-id="${consultaId}"]`);
            if(btn) {
                btn.textContent = "Cancelando...";
                btn.disabled = true;
            }

            const { error } = await supabase
                .from('consultas')
                .delete()
                .eq('id', consultaId);

            if (error) {
                console.error("Erro ao cancelar:", error);
                showNotification(`Erro ao cancelar: ${error.message}`, 'error');
                if(btn) {
                    btn.textContent = "Cancelar Consulta";
                    btn.disabled = false;
                }
                return;
            }

            showNotification('Consulta cancelada com sucesso.', 'success');
            // CORREÇÃO: Voltei para o recarregamento da lista para garantir sincronia total com o banco
            // Isso evita que o usuário ache que deletou se o banco falhar silenciosamente.
            await loadHistoricoConsultas(); 
        }

        async function showRelatorioModal(consultaId) {
            const modal = document.getElementById('relatorio-modal');
            const content = document.getElementById('relatorio-content');
            content.textContent = 'Carregando relatório...';
            const { data, error } = await supabase.from('relatorios').select('relatorio').eq('consulta_id', consultaId).single();
            if (error && error.code !== 'PGRST116') {
                content.textContent = `Erro: ${error.message}`;
            } else if (data) {
                content.textContent = data.relatorio;
            } else {
                content.textContent = 'Relatório ainda não registrado.';
            }
            modal.classList.remove('hidden');
        }

        document.getElementById('close-relatorio-modal').addEventListener('click', () => {
            document.getElementById('relatorio-modal').classList.add('hidden');
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('loading-section'); 
            loadEspecialidades();
            loadMedicos(); 
            setMinDate(); 
            startHeartbeat(); 
        });

    </script>
</body>
</html>